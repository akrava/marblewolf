language: node_js
node_js: "8"
os:
  - linux
  - osx
env:
  - TARGET_ARCH=x64
matrix:
  include:
    - os: linux
      env: TARGET_ARCH=arm
    - os: linux
      env: TARGET_ARCH=ia32
    - os: linux
      env: TARGET_ARCH=arm64
    - os: osx
      osx_image: xcode7.3
cache:
  directories:
    - "node_modules"
install:
  - npm install
  - npm install nodeunit jscoverage coveralls --save-dev
script:
  - npm test
  - curl -Lo travis_after_all.py https://raw.github.com/dmakhno/travis_after_all/master/travis_after_all.py
after_success:
  - python travis_after_all.py https://api.travis-ci.com
  - export $(cat .to_export_back)
  - |
      if [ "$BUILD_LEADER" = "YES" ]; then
        if [ "$BUILD_AGGREGATE_STATUS" = "others_succeeded" ]; then
          npm run coveralls
        else
          echo "Some jobs failed"
        fi
      fi
branches:
  only: master